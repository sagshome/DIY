{% extends "base.html" %}
{% block title %}Add Equity{% endblock %}
{% block content %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  <script>
        document.addEventListener("change", function(event) {
            if (event.target && event.target.type === "checkbox") {
                $.ajax({
                    url: '{% url "equity_search_add" %}',
                    data: {
                        'symbol': event.target.value,
                    },
                    async: true,  // no need to wait
                });
            }
        });

        async function fetchOptions(query) {
            if (query.length < 2) return; // Avoid unnecessary API calls

            var account_value = $("#id_equity_type").val();
            var url = `/stocks/api/search/?q=${query}` + "&t=" + account_value;
            const response = await fetch(url);
            const data = await response.json();

            const container = document.getElementById("checkbox-container");
            container.innerHTML = ""; // Clear previous results

            data.results.forEach(item => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = item.symbol;
                checkbox.name = "options";
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" " + item.symbol + " " + item.shortname));
                container.appendChild(label);
                container.appendChild(document.createElement("br"));
            });
        }
    </script>
<!--
    We need a form that respects the users abilty to check the API
    - We can upload a price file
    - if we have a AV Key we can check the
    - Can we search current price via yahoo or morning star
 -->
<h2>New Equity / Fund request form</h2>
    A new Equity or Fund we must source an API that can best serve up the data required.  By entering the search criteria we can perform some
    background tests.  The results are displayed in a choice list,  select your choice but if not match,  just enter the symbol and our staff
    will work offline to search it out.  Manual requests typically
    take a day or two to fulfill.   A request to add this will be sent via email to our admins when you submit this
    request.<br><br>
    The new equity will be usable, however it will not receive any automatic price / dividend updates until validation
    is complete.
    <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="success_url" value="{{ success_url }}">
        {% for error in form.non_field_errors %}
            <div class="w3-row w3-red">
                {{ error }}
            </div>
        {% endfor %}
        {% for hidden_field in form.hidden_fields %}
            <div class="w3-row w3-blue">
                {{ hidden_field.errors }}
                {{ hidden_field }}
            </div>
        {% endfor %}
        <table>
            <tr style="display: block;">
                <td>{{ form.region.label_tag }}</td>
                <td> {{ form.region }}</td>
                <td> {{ form.region.errors }}</td>
            </tr>
            <tr style="display: block;">
                <td>{{ form.equity_type.label_tag }}</td>
                <td> {{ form.equity_type }}</td>
                <td> {{ form.equity_type.errors }}</td>
            </tr>
            <tr style="display: block;">
                <td>Search Criteria</td>
                <td> <input type="text" id="search" oninput="fetchOptions(this.value)" placeholder="Type to search..."></td>
                <td></td>
            </tr>
            <tr style="display: block;">
                <td>Search Results</td>
                <td>
                    <div id="checkbox-container"></div>
                </td>
            </tr>
            <tr style="display: block;">
                <td>{{ form.symbol.label_tag }}</td>
                <td> {{ form.symbol }}</td>
                <td>{{ form.symbol.errors }}</td>
            </tr>
        </table>
        <a href="{{success_url}}">
            <button class="w3-button-small w3-round-xlarge diy-button diy-blue" type="button">Cancel</button>
        </a>
            - or -
        <input type="submit" class="w3-button-small w3-round-xlarge w3-green" name="submit" value="Submit">
    </form>
{% endblock %}

